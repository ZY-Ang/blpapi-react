<!DOCTYPE html>
<html>
  <head>
    <title>Hello React!</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.0/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.0/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">


		var MainPage = React.createClass({
			getInitialState: function() {
				return {
					receivedData: undefined
				};
			},
			componentDidMount: function() {

			},
			handleQuerySubmit: function(query) {
				return(
				$.ajax({
				    url: 'http://localhost:3000/request?ns=blp&service=refdata&type=ReferenceDataRequest', //URL to hit
				    type: 'POST', 
				    data: JSON.stringify(query),
				    success: function(data) {
				    	console.log(JSON.stringify(data));
				    	this.setState({receivedData: data});
				      }.bind(this),
				    error: function(xhr, status, err) {
				        console.error(this.props.url, status, err.toString());
				      }.bind(this)
			     }))
			},
			render: function() {
				return(
					<div>
					<h1> Hello there! </h1>
					<h3> What would you like to look at? </h3>
					<QueryForm onQuerySubmit={this.handleQuerySubmit} />
					<ReturnInfo data={this.state.receivedData} />
					</div>
				);
			}
		});


		var ReturnInfo = React.createClass({
			render: function(){
				var object = this.props.data;
				var returnedString;
				if(object) {
					var secData = object.data[0].securityData;
					returnedString = secData.map(function (sec) {
						var s = [];
						s.push(<h4> {sec.security} </h4>)
						for (var j in sec.fieldData)
						{
							s.push(<h5> {j.trim() + ": " + sec.fieldData[j]} </h5>);
						}
						return (
							{s}
						);
					});
				}
				return (
					<div className="returnInfo">
						<h4 className="data">
							{returnedString}
						</h4>
					</div>
				)
			}
		});


		var QueryForm = React.createClass({
			handleSubmit: function(e) {
				e.preventDefault();
				var securities = React.findDOMNode(this.refs.securities).value.trim();
				var fields = React.findDOMNode(this.refs.fields).value.trim();
				if(!securities || !fields)
				{
					return;
				}
				securities = securities.split(",");
				fields = fields.split(",");
				securities.forEach(function (sec) {
					sec = sec.trim();
				});
				fields.forEach(function (fld){
					fld = fld.trim();
				})
				this.props.onQuerySubmit({securities: securities, fields: fields});
				React.findDOMNode(this.refs.securities).value = "";
				React.findDOMNode(this.refs.fields).value = "";
				return;					
			},
			render: function() {
				return(
					<form className="queryForm" onSubmit={this.handleSubmit}>
					<input type="text" placeholder="Enter securities here." ref="securities" />
					<input type="text" placeholder="Enter fields here." ref="fields" />
					<input type="submit" value="Post!" />
					</form>
				);
				
			}
		});


		React.render(
		<MainPage />,
		document.body
		);

    </script>
  </body>
</html>